{% from 'security/_macros.html' import render_input %}
<!doctype html>
<title>Passkeys</title>
<h1>Manage Passkeys</h1>

{% if not credential_options %}
<form method="post" action="{{ url_for_security('wan_register') }}">
  {{ wan_register_form.hidden_tag() }}
  {{ render_input(wan_register_form.name) }}
  <div style="margin-bottom: 0.75rem;">
    <label>{{ wan_register_form.usage.label.text }}</label><br>
    {% for subfield in wan_register_form.usage %}
      <label style="display: block; margin: 0.25rem 0;">
        {{ subfield }} {{ subfield.label.text }}
      </label>
    {% endfor %}
  </div>
  <button type="submit">Register passkey</button>
</form>
{% else %}
<p>Complete passkey registration in your browser prompt.</p>
<form method="post" action="{{ url_for_security('wan_register_response') }}" id="wan-register-response-form">
  {{ wan_register_response_form.hidden_tag() }}
  <input type="hidden" id="credential" name="credential" value="">
</form>
<div id="wan-errors" style="color: #b42318;"></div>
{% endif %}

{% if registered_credentials %}
<h2>Registered devices</h2>
<ul>
  {% for credential in registered_credentials %}
  <li>
    <strong>{{ credential.name }}</strong>
    ({{ credential.usage }}, {{ credential.device_type }}, last use: {{ credential.last_use }})
    <form method="post" action="{{ url_for_security('wan_delete') }}" style="display: inline-block; margin-left: 0.5rem;">
      {{ wan_delete_form.hidden_tag() }}
      <input type="hidden" name="credential_id" value="{{ credential.id }}">
      <button type="submit">Delete</button>
    </form>
  </li>
  {% endfor %}
</ul>
{% endif %}

<p><a href="{{ url_for_security('two_factor_setup') }}">Back to 2FA settings</a></p>

{% if credential_options %}
<script>
  function b64urlToArrayBuffer(base64url) {
    const padding = '='.repeat((4 - (base64url.length % 4)) % 4);
    const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(base64);
    const bytes = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; i += 1) {
      bytes[i] = raw.charCodeAt(i);
    }
    return bytes.buffer;
  }

  function arrayBufferToB64url(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i += 1) {
      binary += String.fromCharCode(bytes[i]);
    }
    return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
  }

  function decodeRegistrationOptions(options) {
    const decoded = structuredClone(options);
    decoded.challenge = b64urlToArrayBuffer(decoded.challenge);
    decoded.user.id = b64urlToArrayBuffer(decoded.user.id);
    if (Array.isArray(decoded.excludeCredentials)) {
      decoded.excludeCredentials = decoded.excludeCredentials.map((credential) => ({
        ...credential,
        id: b64urlToArrayBuffer(credential.id),
      }));
    }
    return decoded;
  }

  function encodeRegistrationCredential(credential) {
    return {
      id: credential.id,
      rawId: arrayBufferToB64url(credential.rawId),
      type: credential.type,
      response: {
        clientDataJSON: arrayBufferToB64url(credential.response.clientDataJSON),
        attestationObject: arrayBufferToB64url(credential.response.attestationObject),
        transports: credential.response.getTransports ? credential.response.getTransports() : [],
      },
    };
  }

  async function startRegistration() {
    const options = decodeRegistrationOptions({{ credential_options | tojson }});
    try {
      const credential = await navigator.credentials.create({ publicKey: options });
      if (!credential) {
        throw new Error('No credential returned');
      }
      document.getElementById('credential').value = JSON.stringify(encodeRegistrationCredential(credential));
      document.getElementById('wan-register-response-form').submit();
    } catch (error) {
      const details = error && error.message ? error.message : 'Passkey registration failed.';
      document.getElementById('wan-errors').textContent = details;
    }
  }

  startRegistration();
</script>
{% endif %}
